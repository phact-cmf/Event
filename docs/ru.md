# Event Management

Следует стандартам PSR-14, а также PSR-1, PSR-2, PSR-4, PSR-11.

Основные идеи:
- Следование стандарту PSR-14
- Поддержка приоритетов слушателей
- Возможность автоматического анализа слушателя для сопоставления его с событием
- Возможность подключения контейнера для получения слушателя по классу или имени

## Базовое использование

```php
$listenerProvider = new ListenerProvider();
$listenerProvider->addListener(function (SimpleEvent $event) {
    // Работа с объектом события
}, 100);
$dispatcher = new Dispatcher($listenerProvider);
$dispatcher->dispatch(new SimpleEvent());
```

## Добавление слушателей

Добавление слушателей производится с помощью метода `addListener` объекта `ListenerProvider`.

```php
$listenerProvider->addListener(function (SimpleEvent $event) {
  // Работа с объектом события
}, 100);

// или (например, при отключенном автоматическом анализе аргументов слушателя)

$listenerProvider->addListener(function ($event) {
  // Работа с объектом события
}, 100, SimpleEvent::class);
```

Метод принимает 3 аргумента:

|   Аргумент    |   Тип     |   Значение по-умолчанию     |   Описание  |
|   :---        |   :---    |   :---    |   :---  |
|   $listener   |   [Типы слушателей](#типы-слушателей)   |  -  |  Слушатель. |
|   $priority   |   int   |  100  |    Приоритет. Чем больше приоритет - тем раньше вызовется слушатель относительно слушателей с более низким приоритетом.    |
|   $eventClassName   |   string   |  ''  |    Класс события к которому привязывается событие. Особенно применимо при отключении [автоматического анализа аргументов слушателя](#управление-анализом-аргументов-слушателя)   |


Слушатели согласно PSR-14 могут менять объект события. 

## Отправка события

Отправка события производится с помощью метода `dispatch` объекта `Dispatcher`.

```php
$dispatcher->dispatch(new SimpleEvent());
```

Событие представляет собой объект любого класса.

Событие будет обработано следующим образом:
- Будут найдены все слушатели события именно этого класса, каждому из них в порядке приоритета будет передано событие
- Далее, будут найдены все слушатели события, соответствующие родительским классам переданного события, каждому из них в порядке приоритета будет передано событие
- Далее, будут найдены все слушатели события, соответствующие интерфейсам переданного события, каждому из них в порядке приоритета будет передано событие

Слушатели согласно PSR-14 могут менять объект события, поэтому метод `dispatch` возвращает итоговый (возможно, измененный слушателями) объект события.

Также, согласно PSR-14 при реализации объектом события интерфейса `Psr\EventDispatcher\StoppableEventInterface` 
есть возможность остановить дальнейшую обработку события.

## Типы слушателей

Поддерживается ряд всевозможных типов слушателей.

### Callable

Анонимная функция:

```php
$listenerProvider->addListener(function (SimpleEvent $event) {
  // Работа с объектом события
});
````

### Invokable-объект

Класс:

```
class InvokableListener
{
    public function __invoke(SimpleEvent $event)
    {
        // Работа с объектом события
    }
}
```

Указание слушателя:

```php
$listenerProvider->addListener(new InvokableListener());
````

### Строка - Invokable - id объекта в контейнере

> Для работы данного типа слушателей необходимо [использовать контейнер](#работа-с-контейнером).

Класс:

```
class InvokableListener
{
    public function __invoke(SimpleEvent $event)
    {
        // Работа с объектом события
    }
}
```

Указание слушателя - получение объекта из контейнера по строковому идентификатору:

> Подразумевается, что контейнер по id `invokable_listener` вернет объект `InvokableListener`

```php
$listenerProvider->addListener('invokable_listener');
````

Указание слушателя - получение объекта из контейнера по имени класса:

> Подразумевается, что контейнер по имени класса вернет объект `InvokableListener`

```php
$listenerProvider->addListener(InvokableListener::class);
````

### Массив - объект и метод

Класс:

```
class MethodListener
{
    public function event(SimpleEvent $event): void
    {
        // Работа с объектом события
    }
}
```

Указание слушателя:

```php
$listenerProvider->addListener([new MethodListener(), 'event']);
````

### Массив - id объекта в контейнере и метод

> Для работы данного типа слушателей необходимо [использовать контейнер](#работа-с-контейнером).

Класс:

```
class MethodListener
{
    public function event(SimpleEvent $event): void
    {
        // Работа с объектом события
    }
}
```

Указание слушателя - получение объекта из контейнера по строковому идентификатору:

> Подразумевается, что контейнер по id `method_listener` вернет объект `MethodListener`

```php
$listenerProvider->addListener(['method_listener', 'event']);
````

Указание слушателя - получение объекта из контейнера по имени класса:

> Подразумевается, что контейнер по имени класса вернет объект `MethodListener`

```php
$listenerProvider->addListener([MethodListener::class, 'event']);
````

## Работа с контейнером

Для получения некоторых типов слушателей необходимо передать объект контейнера (PSR-11) в 
конструктор `LisenerProvider`:

```php
$listenerProvider = new ListenerProvider($container);
```

После этого вы сможете указывать в слушателях id объектов в контейнере.

## Управление анализом аргументов слушателя

`LisenerProvider` по-умолчанию автоматически анализирует (с помощью рефлексии) зависимости слушателя.

Отключить эту возможность можно следующим образом:

```php
$listenerProvider->setAnalyzeListener(false);
```

После этого необходимо использовать [третий аргумент метода `addListener`](#добавление-слушателей) для указания класса события к которому привязывается событие.

## Возможность изменения поведения

И `Dispatcher` и `ListenerProvider` являются заменяемыми частями и реализуют интерфейсы:

\Phact\Event\Dispatcher:

```
\Psr\EventDispatcher\EventDispatcherInterface;
```

\Phact\Event\ListenerProvider:

```
\Psr\EventDispatcher\ListenerProviderInterface;
\Phact\Event\ListenerAggregate;
```